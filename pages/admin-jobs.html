<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Naivik Admin | Job Creator</title>
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <link id="pagestyle" href="../assets/css/material-kit.css?v=3.1.0" rel="stylesheet" />
  <style>
    body { background-color: #000; color: #fff; font-family: 'Inter', sans-serif; }
    .admin-card { background: #121212; border: 1px solid rgba(137, 207, 240, 0.2); border-radius: 20px; }
    .form-control { background: #1a1a1a !important; border: 1px solid #333 !important; color: #fff !important; }
    .form-control:focus { border-color: #89CFF0 !important; box-shadow: 0 0 10px rgba(137, 207, 240, 0.2) !important; }
    .text-baby-blue { color: #89CFF0; }
    .btn-baby-blue { background-color: #89CFF0; color: #000; font-weight: bold; }
    .btn-baby-blue:hover { background-color: #78bddb; }
  </style>

  <!-- -------- IMPORTING SUPABASE ------- -->  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="py-6">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="d-flex align-items-center mb-4">
            <h2 class="text-white mb-0">Naivik <span class="text-baby-blue">Job Creator</span></h2>
            <span class="badge border border-info text-info ms-3">Admin Tool</span>
        </div>

        <div class="card admin-card p-4 mt-5 mb-4">
            <h4 class="text-white mb-4">Manage Existing Jobs</h4>
            <div id="admin-job-list" class="table-responsive"></div>
        </div>
        
        <div class="card admin-card p-4 p-md-5">
          <form id="jobForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label text-muted small text-uppercase">Job Title</label>
                <input type="text" class="form-control" id="title" placeholder=" e.g. Senior Developer" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label text-muted small text-uppercase">Reference ID</label>
                <input type="text" class="form-control" id="ref" placeholder=" e.g. NV-2026-001">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label text-muted small text-uppercase">Location</label>
                <input type="text" class="form-control" id="location" placeholder=" Toronto, ON / Remote">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label text-muted small text-uppercase">Salary</label>
                <input type="text" class="form-control" id="salary" placeholder=" e.g. $80k - $100k">
              </div>

              <div class="col-12 mb-3">
                <label class="form-label text-muted small text-uppercase">Short Intro (Shows on listing page)</label>
                <textarea class="form-control" id="shortDesc" rows="2"></textarea>
              </div>

              <div class="col-12 mb-3">
                <label class="form-label text-muted small text-uppercase">Full Responsibilities (One per line)</label>
                <textarea class="form-control" id="responsibilities" rows="4" placeholder="  Lead AI integration&#10;  Manage junior devs"></textarea>
              </div>

              <div class="col-12 mb-4">
                <label class="form-label text-muted small text-uppercase">Requirements (One per line)</label>
                <textarea class="form-control" id="requirements" rows="4" placeholder="  5+ years Bootstrap&#10;  Experience with JSON"></textarea>
              </div>

              <div class="col-12 text-end">
                <button type="button" onclick="publishJob()" class="btn btn-baby-blue px-5" id="submitBtn">Publish Job</button>
              </div>
            </div>
          </form>
        </div>

        <div id="outputArea" class="mt-5 d-none">
            <h5 class="text-baby-blue mb-3">Generated Data:</h5>
            <div class="p-3 bg-dark rounded border border-secondary">
                <pre id="jsonPreview" class="text-success small mb-0" style="white-space: pre-wrap;"></pre>
            </div>
            <p class="mt-3 text-muted small">Copy this and add it to your <code>jobs.json</code> file, or click download.</p>
            <button onclick="downloadJSON()" class="btn btn-outline-info">Download jobs.json</button>
        </div>

      </div>
    </div>
  </div>

    <script>
        // 1. Initialize Supabase
        const SUPABASE_URL = 'https://duiqfjsogpiadxhdmdqz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1aXFmanNvZ3BpYWR4aGRtZHF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NDM2NDQsImV4cCI6MjA4MzIxOTY0NH0.jyUwREEPhchkWDYX2y7M8WUNkvA94p_J2aiIgoirv8M';
        const naivikSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 1. Load jobs into the management list on page load
        async function loadAdminList() {
        const listContainer = document.getElementById('admin-job-list');
        const { data: jobs, error } = await naivikSupabase.from('jobs').select('id, title, location');

        if (error) return console.error(error);

        listContainer.innerHTML = `
            <table class="table text-white">
            <thead>
                <tr>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Title</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Location</th>
                <th class="text-secondary opacity-7">Actions</th>
                </tr>
            </thead>
            <tbody>
                ${jobs.map(job => `
                <tr>
                    <td><p class="text-sm font-weight-bold mb-0">${job.title}</p></td>
                    <td><p class="text-sm mb-0">${job.location}</p></td>
                    <td>
                    <button onclick="editJob(${job.id})" class="btn btn-sm btn-outline-info me-2">Edit</button>
                    <button onclick="deleteJob(${job.id})" class="btn btn-sm btn-outline-danger">Delete</button>
                    </td>
                </tr>
                `).join('')}
            </tbody>
            </table>
        `;
        }

        // 2. Delete Logic
        async function deleteJob(id) {
        const password = prompt("Enter Admin Password to DELETE this listing:");
        if (password !== "pass") return alert("Unauthorized");

        if (confirm("Are you sure you want to delete this job? This cannot be undone.")) {
            const { error } = await naivikSupabase.from('jobs').delete().eq('id', id);
            if (error) alert("Error deleting: " + error.message);
            else {
            alert("Job deleted successfully.");
            loadAdminList(); // Refresh list
            }
        }
        }

        // 3. Edit Logic (Loads data back into the form)
        let editingId = null;

        async function editJob(id) {
        const { data: job, error } = await naivikSupabase.from('jobs').select('*').eq('id', id).single();
        
        if (job) {
            editingId = id; // Store the ID we are editing
            document.getElementById('title').value = job.title;
            document.getElementById('ref').value = job.ref;
            document.getElementById('location').value = job.location;
            document.getElementById('salary').value = job.salary;
            document.getElementById('shortDesc').value = job.shortDescription;
            document.getElementById('responsibilities').value = job.responsibilities.join('\n');
            document.getElementById('requirements').value = job.requirements.join('\n');
            
            document.getElementById('submitBtn').innerText = "Update Existing Job";
            window.scrollTo(0, 0); // Scroll to top to see the form
        }
        }

        // 4. Unified Submit Function (Handles both Insert and Update)
        async function publishJob() {
        const password = prompt("Enter Admin Password to Publish/Update:");
        if (password !== "pass") return alert("Unauthorized");

        const jobData = {
            title: document.getElementById('title').value,
            ref: document.getElementById('ref').value,
            location: document.getElementById('location').value,
            salary: document.getElementById('salary').value,
            shortDescription: document.getElementById('shortDesc').value,
            intro: document.getElementById('shortDesc').value,
            responsibilities: document.getElementById('responsibilities').value.split('\n').filter(s => s.trim()),
            requirements: document.getElementById('requirements').value.split('\n').filter(s => s.trim()),
            posted: new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }),
            type: "Permanent"
        };

        let result;
        if (editingId) {
            // UPDATE existing
            result = await naivikSupabase.from('jobs').update(jobData).eq('id', editingId);
        } else {
            // INSERT new
            result = await naivikSupabase.from('jobs').insert([jobData]);
        }

        if (result.error) alert("Error: " + result.error.message);
        else {
            alert(editingId ? "Job updated!" : "Job published!");
            location.reload(); // Refresh to reset state
        }
        }

        document.addEventListener('DOMContentLoaded', loadAdminList);

    </script>

    <script> 
        // Check if the element exists before trying to access classList
        const mist = document.getElementById('blue-mist');
        const section = document.getElementById('observed-section');

        if (mist && section) { // Only run if both elements are on the page
        window.addEventListener('scroll', () => {
            const rect = section.getBoundingClientRect();
            mist.style.opacity = (rect.top < window.innerHeight && rect.bottom > 0) ? "1" : "0";
        });
        }

        // Check for the Glow Containers
        const containers = document.querySelectorAll('.glow-container');
        if (containers.length > 0) {
        containers.forEach(container => {
            container.addEventListener('mousemove', e => {
            const cards = container.getElementsByClassName('glow-card-wrapper');
            if (cards.length > 0) { // Safety check
                for (const card of cards) {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                card.style.setProperty("--mouse-x", `${x}px`);
                card.style.setProperty("--mouse-y", `${y}px`);
                }
            }
            });
        });
        }
    </script>

  </body>
</html>