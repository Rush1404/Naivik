<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Naivik Admin | Job Creator</title>
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <link id="pagestyle" href="../assets/css/material-kit.css?v=3.1.0" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  
  <style>
    body { background-color: #000; color: #fff; font-family: 'Inter', sans-serif; }
    .admin-card { background: #121212; border: 1px solid rgba(137, 207, 240, 0.2); border-radius: 20px; }
    
    /* Premium Input Styling with proper left-side spacing */
    .form-control { 
      background: #1a1a1a !important; 
      border: 1px solid #333 !important; 
      color: #fff !important; 
      padding: 14px 22px !important; 
      border-radius: 10px !important; 
      transition: all 0.2s ease;
    }

    textarea.form-control { padding: 18px 22px !important; line-height: 1.6; }

    .form-control:focus { 
      border-color: #89CFF0 !important; 
      box-shadow: 0 0 12px rgba(137, 207, 240, 0.2) !important; 
      background: #1f1f1f !important;
    }

    .form-label { margin-left: 4px; margin-bottom: 8px; letter-spacing: 0.5px; color: #aaa; }
    .text-baby-blue { color: #89CFF0; }
    .btn-baby-blue { background-color: #89CFF0; color: #000; font-weight: bold; border-radius: 10px; }
    .btn-baby-blue:hover { background-color: #78bddb; transform: translateY(-1px); }

    /* Drag and Drop Visuals */
    .sortable-ghost { opacity: 0.3; background: #89CFF0 !important; border: 1px dashed #89CFF0; }
    .sortable-chosen { background: #1a1a1a !important; }
    .sortable-row { transition: background 0.2s; }
    .sortable-row:hover { background: rgba(255,255,255,0.02); }
    
    /* Inactive/Draft Styling */
    .grayscale { filter: grayscale(1) brightness(0.6); opacity: 0.6 !important; }
    .form-check-input:checked { background-color: #89CFF0 !important; border-color: #89CFF0 !important; }
    
    .drag-handle { cursor: grab; user-select: none; }
    .drag-handle:active { cursor: grabbing; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>

<body class="py-6">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        
        <div class="d-flex align-items-center justify-content-between mb-4">
          <div class="d-flex align-items-center">
              <h2 class="text-white mb-0">Naivik <span class="text-baby-blue">Job Creator</span></h2>
              <span class="badge border border-info text-info ms-3">Admin Portal</span>
          </div>
          <a href="careers.html" class="btn btn-outline-light btn-sm mb-0">
            <i class="material-symbols-rounded align-middle me-1">arrow_back</i> View Careers Page
          </a>
        </div>

        <div class="card admin-card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="text-white mb-0">Manage Listings</h4>
                <small class="text-muted">Drag <span class="material-symbols-rounded align-middle fs-6">drag_indicator</span> to reorder</small>
            </div>
            <div id="admin-job-list" class="table-responsive">
                </div>
        </div>
        
        <div class="card admin-card p-4 p-md-5">
          <h4 class="text-white mb-4" id="formTitle">Create New Job Listing</h4>
          <form id="jobForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label small text-uppercase font-weight-bold">Job Title</label>
                <input type="text" class="form-control" id="title" placeholder="e.g. Platform Operations Manager" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label small text-uppercase font-weight-bold">Reference ID</label>
                <input type="text" class="form-control" id="ref" placeholder="e.g. J107">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label small text-uppercase font-weight-bold">Location</label>
                <input type="text" class="form-control" id="location" placeholder="Remote / Hybrid">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label small text-uppercase font-weight-bold">Salary Range</label>
                <input type="text" class="form-control" id="salary" placeholder="e.g. $120k - $150k">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label small text-uppercase font-weight-bold">Display Priority</label>
                <input type="number" class="form-control" id="priority" placeholder="0" value="0">
              </div>

              <div class="col-12 mb-3">
                <label class="form-label small text-uppercase font-weight-bold">Short Intro (Summary)</label>
                <textarea class="form-control" id="shortDesc" rows="2" placeholder="Brief 2-line hook for the listing page..."></textarea>
              </div>

              <div class="col-12 mb-3">
                <label class="form-label small text-uppercase font-weight-bold">Full Responsibilities (One per line)</label>
                <textarea class="form-control" id="responsibilities" rows="5" placeholder="Manage vendor performance&#10;Lead incident reviews"></textarea>
              </div>

              <div class="col-12 mb-4">
                <label class="form-label small text-uppercase font-weight-bold">Requirements (One per line)</label>
                <textarea class="form-control" id="requirements" rows="5" placeholder="5+ years experience&#10;Technical conversance"></textarea>
              </div>

              <div class="col-12 d-flex justify-content-between align-items-center">
                <button type="button" onclick="resetForm()" class="btn btn-link text-muted" id="cancelBtn" style="display:none;">Cancel Edit</button>
                <button type="button" onclick="publishJob()" class="btn btn-baby-blue px-5 ms-auto" id="submitBtn">Publish Job</button>
              </div>
            </div>
          </form>
        </div>

      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://duiqfjsogpiadxhdmdqz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1aXFmanNvZ3BpYWR4aGRtZHF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NDM2NDQsImV4cCI6MjA4MzIxOTY0NH0.jyUwREEPhchkWDYX2y7M8WUNkvA94p_J2aiIgoirv8M';
    const naivikSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let editingId = null;

    async function loadAdminList() {
      const listContainer = document.getElementById('admin-job-list');
      const { data: jobs, error } = await naivikSupabase
        .from('jobs')
        .select('*')
        .order('priority', { ascending: false });

      if (error) return console.error("Fetch error:", error);

      listContainer.innerHTML = `
        <table class="table align-items-center text-white mb-0">
          <thead>
            <tr>
              <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Job Title</th>
              <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Status</th>
              <th class="text-secondary opacity-7"></th>
            </tr>
          </thead>
          <tbody>
            ${jobs.map(job => {
              const active = job.is_active !== false;
              return `
                <tr data-id="${job.id}" class="sortable-row ${active ? '' : 'grayscale'}">
                  <td>
                    <div class="d-flex px-2 py-1 align-items-center">
                      <span class="material-symbols-rounded text-muted me-3 drag-handle">drag_indicator</span>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">${job.title}</h6>
                        <p class="text-xs text-secondary mb-0">${job.location || 'No Location'}</p>
                      </div>
                    </div>
                  </td>
                  <td class="align-middle text-sm">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" ${active ? 'checked' : ''} 
                        onclick="toggleJobStatus(${job.id}, this.checked)">
                      <label class="text-xxs text-uppercase font-weight-bold ms-2">${active ? 'Active' : 'Draft'}</label>
                    </div>
                  </td>
                  <td class="align-middle text-end">
                    <button onclick="editJob(${job.id})" class="btn btn-link text-info text-gradient px-3 mb-0">
                      <i class="material-symbols-rounded text-sm me-2">edit</i>Edit
                    </button>
                    <button onclick="deleteJob(${job.id})" class="btn btn-link text-danger text-gradient px-3 mb-0">
                      <i class="material-symbols-rounded text-sm me-2">delete</i>Delete
                    </button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
      initDraggableTable();
    }

    function initDraggableTable() {
      const el = document.querySelector('#admin-job-list tbody');
      Sortable.create(el, {
        animation: 150,
        handle: '.drag-handle',
        ghostClass: 'sortable-ghost',
        onEnd: async function () {
          const rows = Array.from(el.querySelectorAll('tr'));
          const updates = rows.map((row, index) => {
            return naivikSupabase
              .from('jobs')
              .update({ priority: rows.length - index })
              .eq('id', row.getAttribute('data-id'));
          });
          await Promise.all(updates);
          console.log("Order synced with Supabase.");
        },
      });
    }

    async function toggleJobStatus(id, newStatus) {
      const { error } = await naivikSupabase.from('jobs').update({ is_active: newStatus }).eq('id', id);
      if (error) alert("Toggle failed: " + error.message);
      else loadAdminList();
    }

    async function publishJob() {
      const password = prompt("Enter Admin Password:");
      if (password !== "pass") return alert("Unauthorized");

      const jobData = {
        title: document.getElementById('title').value,
        ref: document.getElementById('ref').value,
        location: document.getElementById('location').value,
        salary: document.getElementById('salary').value,
        priority: parseInt(document.getElementById('priority').value) || 0,
        shortDescription: document.getElementById('shortDesc').value,
        responsibilities: document.getElementById('responsibilities').value.split('\n').filter(s => s.trim()),
        requirements: document.getElementById('requirements').value.split('\n').filter(s => s.trim()),
        is_active: true,
        posted: new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })
      };

      let result;
      if (editingId) {
        result = await naivikSupabase.from('jobs').update(jobData).eq('id', editingId);
      } else {
        result = await naivikSupabase.from('jobs').insert([jobData]);
      }

      if (result.error) alert("Error: " + result.error.message);
      else {
        alert(editingId ? "Changes Saved!" : "Job Published!");
        resetForm();
        loadAdminList();
      }
    }

    async function editJob(id) {
      const { data: job, error } = await naivikSupabase.from('jobs').select('*').eq('id', id).single();
      if (job) {
        editingId = id;
        document.getElementById('title').value = job.title;
        document.getElementById('ref').value = job.ref;
        document.getElementById('location').value = job.location;
        document.getElementById('salary').value = job.salary;
        document.getElementById('priority').value = job.priority || 0;
        document.getElementById('shortDesc').value = job.shortDescription;
        document.getElementById('responsibilities').value = job.responsibilities.join('\n');
        document.getElementById('requirements').value = job.requirements.join('\n');
        
        document.getElementById('formTitle').innerText = "Edit Listing: " + job.title;
        document.getElementById('submitBtn').innerText = "Update Listing";
        document.getElementById('cancelBtn').style.display = "inline-block";
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      }
    }

    function resetForm() {
      editingId = null;
      document.getElementById('jobForm').reset();
      document.getElementById('formTitle').innerText = "Create New Job Listing";
      document.getElementById('submitBtn').innerText = "Publish Job";
      document.getElementById('cancelBtn').style.display = "none";
    }

    async function deleteJob(id) {
      if (confirm("Delete this listing permanently?")) {
        const { error } = await naivikSupabase.from('jobs').delete().eq('id', id);
        if (!error) loadAdminList();
      }
    }

    document.addEventListener('DOMContentLoaded', loadAdminList);
  </script>
</body>
</html>